# Docker
---
## Useful links

[Шпаргалка по docker](https://habr.com/ru/companies/flant/articles/336654/)  
[Configure remote access for Docker daemon](https://docs.docker.com/config/daemon/remote-access/)  
[Как работают и создаются тома с bind и mount в Docker](https://fixmypc.ru/post/sozdaem-volume-v-docker-ispolzuia-bind-i-mount/)  
[Таймер для очистки докера](https://gist.github.com/sirkonst/413475ee055a588c58661363c461122e)  

## Basic commands

| Command                                                                                                                                       | Description                                                                                                                                                 |
|-----------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `docker --help`                                                                                                                               | - список доступных команд                                                                                                                                   |
| `docker <command> --help`                                                                                                                     | - информация по команде                                                                                                                                     |
| `docker --version`                                                                                                                            | - версия Docker                                                                                                                                             |
| `docker info`                                                                                                                                 | - общая информация о системе                                                                                                                                |
| **Работа с образами**                                                                                                                         |                                                                                                                                                             |
| `docker search debian`                                                                                                                        | - поиск образов по ключевому слову debi                                                                                                                     |
| `docker pull ubuntu`                                                                                                                          | - скачивание последней версии (тег по умолчанию latest) официального образа ubuntu (издатель не указывается) из репозитория по умолчанию docker.io/library  |
| `docker pull prom/prometheus`                                                                                                                 | - скачивание последней версии (latest) образа prometheus от издателя prom из репозитория docker.io/prom                                                     |
| `docker pull docker.io/library/ubuntu:18.04`                                                                                                  | - скачивание из репозитория docker.io официального образа ubuntu с тегом 18.04                                                                              |
|                                                                                                                                               |                                                                                                                                                             |
| `docker images`                                                                                                                               | - просмотр локальных образов                                                                                                                                |
|                                                                                                                                               |                                                                                                                                                             |
| `docker rmi <image_name>:<tag>`                                                                                                               | - удаление образа. Вместо <image_name>:<tag> можно указать <image_id>. Для удаления образа все контейнеры на его основе должны быть как минимум остановлены |
| `docker rmi $(docker images -aq)`                                                                                                             | - удаление всех образов                                                                                                                                     |
| **Работа с контейнерами**                                                                                                                     |                                                                                                                                                             |
| `docker run hello-world`                                                                                                                      | - Hello, world! в мире контейнеров                                                                                                                          |
| `docker run -it ubuntu bash`                                                                                                                  | - запуск контейнера ubuntu и выполнение команды bash в интерактивном режиме                                                                                 |
| `docker run --name docker-getting-started --publish 8080:80 docker/getting-started`                                                           | - запуск контейнера getting-started с отображением (маппингом) порта 8080 хоста на порт 80 внутрь контейнера                                                |
| `docker run --detach --name mongodb docker.io/library/mongo:4.4.10`                                                                           | - запуск контейнера mongodb с именем mongodb в фоновом режиме. Данные будут удалены при удалении контейнера!                                                |
|                                                                                                                                               |                                                                                                                                                             |
| `docker ps`                                                                                                                                   | - просмотр запущенных контейнеров                                                                                                                           |
| `docker ps -a`                                                                                                                                | - просмотр всех контейнеров (в том числе остановленных)                                                                                                     |
| `docker stats --no-stream`                                                                                                                    | - просмотр статистики                                                                                                                                       |
|                                                                                                                                               |                                                                                                                                                             |
| `docker start alpine`                                                                                                                         | - создание контейнера из образа alpine                                                                                                                      |
|                                                                                                                                               |                                                                                                                                                             |
| `docker start <container_name>`                                                                                                               | - запуск созданного контейнера. Вместо <container_name> можно указать <container_id>                                                                        |
| `docker start $(docker ps -a -q)`                                                                                                             | - запуск всех созданных контейнеров                                                                                                                         |
|                                                                                                                                               |                                                                                                                                                             |
| `docker stop <container_name>`                                                                                                                | - остановка контейнера. Вместо <container_name> можно указать <container_id>                                                                                |
| `docker stop $(docker ps -a -q)`                                                                                                              | - остановка всех контейнеров                                                                                                                                |
|                                                                                                                                               |                                                                                                                                                             |
| `docker rm <container_name>`                                                                                                                  | - удаление контейнера. Вместо <container_name> можно указать <container_id>                                                                                 |
| `docker rm $(docker ps -a -q)`                                                                                                                | - удаление всех контейнеров                                                                                                                                 |
| **Система**                                                                                                                                   |                                                                                                                                                             |
| `docker system info`                                                                                                                          | - общая информация о системе (соответствует docker info)                                                                                                    |
| `docker system df`                                                                                                                            | - общее потребление                                                                                                                                         |
| `docker system prune -af`                                                                                                                     | - удаление неиспользуемых данных и очистка диска                                                                                                            |
| **Полезное**                                                                                                                                  |                                                                                                                                                             |
| `docker network create -d bridge my_bridge`                                                                                                   | - создать bridge network                                                                                                                                    |
| `docker rename 345df9ed5b47 new_name`                                                                                                         | - переименовать контейнер                                                                                                                                   |
| `docker logs -f 0d026fa99f0e`                                                                                                                 | - логи контейнера                                                                                                                                           |
| `docker exec -it ab108ca1d8e9 env`                                                                                                            | - выод переменных контейнера                                                                                                                                |
| `docker exec -it ab108ca1d8e9 printenv UVICORN__HOST`                                                                                         | - вывод значения одной переменной                                                                                                                           |
| `docker cp postgres:/var/lib/postgresql/data/postgresql.conf /home/devops/postgresql`                                                         | - скопировать файл из контейнера                                                                                                                            |
| `docker plugin ls`                                                                                                                            | - список плагинов                                                                                                                                           |
| `systemctl restart docker`                                                                                                                    | - рестарт докера                                                                                                                                            |
| `sudo journalctl -xeu docker.service`                                                                                                         | - журналы докера                                                                                                                                            |
| `sudo journalctl -eu docker`                                                                                                                  | - журналы докера                                                                                                                                            |
| `sudo systemctl edit --full docker`                                                                                                           | - сервис                                                                                                                                                    |
| `docker ps -q \| xargs -n 1 docker inspect --format '{{ .Name }} {{range .NetworkSettings.Networks}} {{.IPAddress}}{{end}}' \| sed 's#^/##';` | - вывод имен контейнеров с IP                                                                                                                               |
| `sudo vi /etc/docker/daemon.json`                                                                                                             | - конфиг докер-демона                                                                                                                                       |

**Запуск контейнера с параметрами**
`docker run --name promtail -d -v /home/d.safronov/grafana/:/mnt/config -v /var/log:/var/log --link loki-devops -it --net insurance grafana/promtail:2.9.1 -config.file=/mnt/config/promtail-config.yaml`
`docker run --name promtail -d -v /home/d.safronov/grafana/:/mnt/config -v /var/lib/docker/containers:/var/lib/docker/containers --link loki-devops -it --net insurance grafana/promtail:2.9.1 -config.file=/mnt/config/promtail-config.yaml`

# Loki
---

**Обновление и перезапуск Loki**
```
docker plugin ls
docker plugin disable loki --force
docker plugin upgrade loki grafana/loki-docker-driver:2.9.1 --grant-all-permissions
docker plugin enable loki
systemctl restart docker
```
**Проверка доступности**
```
curl http://172.18.0.1:3100/ready
curl http://172.18.0.1:3100/loki/api/v1/labels
```

# GitLab runner
---

/etc/gitlab-runner/config.toml				- конфиги раннеров  

`gitlab-runner uninstall`   - stops and uninstalls GitLab Runner from being run as an service  
`gitlab-runner start`       - starts the GitLab Runner service  
`gitlab-runner stop`        - stops the GitLab Runner service  
`gitlab-runner restart`     - stops and then starts the GitLab Runner service  
`gitlab-runner status`      - prints the status of the GitLab Runner service. The exit code is zero when the service is running and non-zero when the service is not running  

# Nginx
---

nginx -s <сигнал>  
Где сигнал может быть одним из нижеследующих:  

`stop`    - быстрое завершение  
`quit`    - плавное завершение  
`reload`  - перезагрузка конфигурационного файла  
`reopen`  - переоткрытие лог-файлов  

docker run -p 127.0.0.1:8080:80 nginx   - запуск контейнера nginx  

# Kubernetes
---

[Установка k8s на ubuntu](https://www.heyvaldemar.net/ustanovka-kubernetes-na-ubuntu-server-22-04-lts/)  
[Как копировать файлы между модулями Kubernetes и вашей машиной](https://ru.linux-console.net/?p=7675)  

`sudo hostnamectl set-hostname <NAME>`	- присвоение имени хосту  

| Command                                                                                                                                                                                                          | Description                                                                                                                                                                                              |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Get-команды с основном выводом**                                                                                                                                                                               |                                                                                                                                                                                                          |
| `kubectl get services`                                                                                                                                                                                           | - вывести все сервисы в пространстве имён                                                                                                                                                                |
| `kubectl get pods --all-namespaces`                                                                                                                                                                              | - вывести все поды во всех пространств имён                                                                                                                                                              |
| `kubectl get pods -o wide`                                                                                                                                                                                       | - вывести все поды в текущем пространстве имён с подробностями                                                                                                                                           |
| `kubectl get deployment my-dep`                                                                                                                                                                                  | - вывести определённое развёртывание                                                                                                                                                                     |
| `kubectl get pods`                                                                                                                                                                                               | - вывести все поды в пространстве имён                                                                                                                                                                   |
| `kubectl get pod my-pod -o yaml`                                                                                                                                                                                 | - получить информацию по поду в формате YAML                                                                                                                                                             |
| `kubectl describe nodes my-node`<br/>`kubectl describe pods my-pod`                                                                                                                                              | - описание нод и подов                                                                                                                                                                                   |
| `kubectl get services --sort-by=.metadata.name`                                                                                                                                                                  | - вывести сервисы, отсортированные по имени                                                                                                                                                              |
| `kubectl get pods --sort-by='.status.containerStatuses[0].restartCount'`                                                                                                                                         | - вывести поды, отсортированные по количеству перезагрузок                                                                                                                                               |
| `kubectl get pv --sort-by=.spec.capacity.storage`                                                                                                                                                                | - вывести постоянные тома (PersistentVolumes), отсортированные по емкости                                                                                                                                |
| `kubectl get pods --selector=app=cassandra -o jsonpath='{.items[*].metadata.labels.version}'`                                                                                                                    | - получить метку версии всех подов с меткой app=cassandra                                                                                                                                                |
| `kubectl get node --selector='!node-role.kubernetes.io/master'`                                                                                                                                                  | - получить все рабочие узлы                                                                                                                                                                              |
| `kubectl get pods --field-selector=status.phase=Running`                                                                                                                                                         | - получить все запущенные поды в пространстве имён                                                                                                                                                       |
| `kubectl get nodes -o jsonpath='{.items[*].status.addresses[?(@.type=="ExternalIP")].address}'`                                                                                                                  | - получить внешние IP-адреса (ExternalIP) всех узлов                                                                                                                                                     |
| `sel=${$(kubectl get rc my-rc --output=json \| jq -j '.spec.selector \| to_entries \| .[] \| "\(.key)=\(.value),"')%?}`<br/>`echo $(kubectl get pods --selector=$sel --output=jsonpath={.items..metadata.name})` | - вывести имена подов, принадлежащие к определённому RC                                                                                                                                                  |
| `kubectl get pods --show-labels`                                                                                                                                                                                 | - показать метки всех подов (или любого другого объекта Kubernetes, которым можно прикреплять метки)                                                                                                     |
| `JSONPATH='{range .items[]}{@.metadata.name}:{range @.status.conditions[]}{@.type}={@.status};{end}{end}' \`<br/>`&& kubectl get nodes -o jsonpath="$JSONPATH" \| grep "Ready=True"`                             | - получить готовые узлы                                                                                                                                                                                  |
| `kubectl get secret my-secret -o go-template='{{range $k,$v := .data}}{{"### "}}{{$k}}{{"\n"}}{{$v \| base64decode}}{{"\n\n"}}{{end}}'`                                                                          | - вывод декодированных секретов без внешних инструментов                                                                                                                                                 |
| `kubectl get pods -o json \| jq '.items[].spec.containers[].env[]?.valueFrom.secretKeyRef.name'\| grep -v null \| sort \| uniq`                                                                                  | - вывести все секреты, используемые сейчас в поде                                                                                                                                                        |
| `kubectl get pods --all-namespaces -o jsonpath='{range .items[].status.initContainerStatuses[]}{.containerID}{"\n"}{end}' \| cut -d/ -f3`                                                                        | - вывести все идентификаторы (containerID) контейнеров инициализации (initContainers) во всех подах.<br/>Это полезно при очистке остановленных контейнеров, не удаляя при этом контейнеры инициализации. |
| `kubectl get events --sort-by=.metadata.creationTimestamp`                                                                                                                                                       | - вывести события, отсортированные по временной метке                                                                                                                                                    |
| `kubectl diff -f ./my-manifest.yaml`                                                                                                                                                                             | - сравнить текущее состояние кластера с состоянием, в котором находился бы кластер в случае применения манифеста                                                                                         |
| **Информация о кластере**                                                                                                                                                                                        |                                                                                                                                                                                                          |
| `kubectl version`                                                                                                                                                                                                | - вывод информации о версии клиента и сервера                                                                                                                                                            |
| `kubectl api-resources`                                                                                                                                                                                          | - вывод поддерживаемых ресурсов API на сервере                                                                                                                                                           |
| `kubectl api-versions`                                                                                                                                                                                           | - вывод поддерживаемых версий API на сервере, в виде «group/version»                                                                                                                                     |
| `kubectl cluster-info`                                                                                                                                                                                           | - получение информации о кластере                                                                                                                                                                        |
| `kubectl get nodes`                                                                                                                                                                                              | - получение списка узлов в кластере                                                                                                                                                                      |
| `kubectl get nodes master -o wide`                                                                                                                                                                               | - получение информации о главном узле                                                                                                                                                                    |
| `kubectl describe nodes master`                                                                                                                                                                                  | - получение подробной информации о главных узлах                                                                                                                                                         |
| **Информация о конфигурации**                                                                                                                                                                                    |                                                                                                                                                                                                          |
| `kubectl config view`                                                                                                                                                                                            | - отображать всех настроек kubeconfig                                                                                                                                                                    |
| `kubectl config current-context`                                                                                                                                                                                 | - просмотр текущего контекста                                                                                                                                                                            |
| `kubectl config get-clusters`                                                                                                                                                                                    | - показать кластеры, определенные в kubeconfig                                                                                                                                                           |
| `kubectl config get-contexts`                                                                                                                                                                                    | - описать один или много контекстов                                                                                                                                                                      |
| **Пространства имен**                                                                                                                                                                                            |                                                                                                                                                                                                          |
| `kubectl get namespaces`                                                                                                                                                                                         | - получить все пространства имен                                                                                                                                                                         |
| `kubectl get namespaces -...o yaml`                                                                                                                                                                              | - получить информацию о пространстве имен в формате yaml                                                                                                                                                 |
| `kubectl describe namespace default`                                                                                                                                                                             | - описать пространство имен по умолчанию                                                                                                                                                                 |
| `kubectl create namespace my-namespace`                                                                                                                                                                          | - создать новое пространство имен                                                                                                                                                                        |
| `kubectl delete namespace my-namespace`                                                                                                                                                                          | - удалить пространство имен                                                                                                                                                                              |
| **Модули**                                                                                                                                                                                                       |                                                                                                                                                                                                          |
| `kubectl get pods --namespace=my-namespace`                                                                                                                                                                      | - получить pods из указанного пространства имен                                                                                                                                                          |
| `kubectl run my-pod-1 --image=nginx:latest --dry-run`                                                                                                                                                            | - создать модуль                                                                                                                                                                                         |
| `kubectl run my-pod-1 --image=nginx:latest --dry-run=client`                                                                                                                                                     | - посмотреть, как будет обрабатываться pod                                                                                                                                                               |
| `kubectl run my-pod-2 --image=nginx:latest --namespace=my-namespace`                                                                                                                                             | - создать pod в указанном пространстве имен                                                                                                                                                              |
| `kubectl run nginx --image=nginx -l --labels=app=test`                                                                                                                                                           | - создать pod с меткой к нему                                                                                                                                                                            |
| `kubectl get pods --show-labels`                                                                                                                                                                                 | - получить все pod с выводом меток                                                                                                                                                                       |
| `kubectl get pods -o wide`                                                                                                                                                                                       | - получить капсулы с расширенным/широким выводом                                                                                                                                                         |
| `kubectl get pods --sort-by=.metadata.name`                                                                                                                                                                      | - перечислить капсулы в отсортированном порядке                                                                                                                                                          |
| `kubectl logs my-pod-1`                                                                                                                                                                                          | - получение журналов пода                                                                                                                                                                                |
| `kubectl get pods my-pod-2 --namespace=my-namespace -o wide`                                                                                                                                                     | - получение подов в указанном пространстве имен с расширенным/широким выводом                                                                                                                            |
| `kubectl logs my-pod-2 --namespace=my-namespace`                                                                                                                                                                 | - получить журналы pod в указанном пространстве имен                                                                                                                                                     |
| `kubectl describe pod my-pod-1`                                                                                                                                                                                  | - описать pod                                                                                                                                                                                            |
| `kubectl describe pods my-pod-1 --namespace=my-namespace`                                                                                                                                                        | - описать pod в указанном пространстве имен                                                                                                                                                              |
| `kubectl delete pod my-pod-1`                                                                                                                                                                                    | - удалить pod из текущего пространства имен                                                                                                                                                              |
| `kubectl delete pods my-pod-1 --namespace=my-namespace`                                                                                                                                                          | - удалить pod из указанного пространства имен                                                                                                                                                            |
| **Развертывания**                                                                                                                                                                                                |                                                                                                                                                                                                          |
| `kubectl get deployments`                                                                                                                                                                                        | - получение списка развертываний из текущего пространства имен                                                                                                                                           |
| `kubectl get deployments --namespace=my-namespace`                                                                                                                                                               | - получение списка развертываний из указанного пространства имен                                                                                                                                         |
| `kubectl create deployment my-deployment-1 --image=nginx`                                                                                                                                                        | - создать развертывание                                                                                                                                                                                  |
| `kubectl get deployment my-deployment-1`                                                                                                                                                                         | - получить указанное развертывание                                                                                                                                                                       |
| `kubectl get deployment my-deployment-1 --show-labels`                                                                                                                                                           | - получить указанное развертывание с его метками                                                                                                                                                         |
| `kubectl describe deployments my-deployment-1`                                                                                                                                                                   | - описать указанное развертывание                                                                                                                                                                        |
| `kubectl get deployment my-deployment-1 -o yaml`                                                                                                                                                                 | - получить подробную информацию о развертывании в формате yaml                                                                                                                                           |
| `kubectl set image deployment my-deployment-1 nginx=nginx:1.16.1`                                                                                                                                                | - измените образ в существующем развертывании                                                                                                                                                            |
| `kubectl rollout history deployment my-deployment-1`                                                                                                                                                             | - просмотр истории развертывания                                                                                                                                                                         |
| `kubectl rollout undo deployment my-deployment-1`                                                                                                                                                                | - отмена предыдущего развертывания                                                                                                                                                                       |
| `kubectl rollout undo deployment my-deployment-1 --to-revision=2`                                                                                                                                                | - возврат к определенной версии истории развертывания                                                                                                                                                    |
| `kubectl rollout status deployment my-deployment-1`                                                                                                                                                              | - показать статус развертывания                                                                                                                                                                          |
| `kubectl rollout restart deployment my-deployment-1`                                                                                                                                                             | - перезапустить ресурс                                                                                                                                                                                   |
| `kubectl scale --replicas=3 deployment my-deployment-1`                                                                                                                                                          | - масштабировать развертывание до 3                                                                                                                                                                      |
| `kubectl scale --current-replicas=3 --replicas=5 deployment my-deployment-1`                                                                                                                                     | - масштабировать с текущего количества до нужного                                                                                                                                                        |
| `kubectl autoscale deployment my-deployment-1 --min=2 --max=10`                                                                                                                                                  | - создать HPA (Horizontal Pod Aotuscaler)                                                                                                                                                                |
| **Services**                                                                                                                                                                                                     |                                                                                                                                                                                                          |
| `kubectl run my-pod --image=nginx --labels=app=myapp`                                                                                                                                                            | - создать pod с меткой                                                                                                                                                                                   |
| `kubectl expose pod my-pod --port=80 --name nginx-service --type=NodePort --dry-run=client -o yaml`                                                                                                              | - создаем сервис типа NodePort, который будет использовать метки pod для селектора, но нам нужно указать тип, поэтому сначала создайте файл определения, а затем создайте сервис                         |
| `kubectl create service nodeport nginx --tcp=80:80 --node-port=30080 --dry-run=client -o yaml`                                                                                                                   | - создать сервис, который будет иметь тип NodePort, но у него не будет селектора как у my-app                                                                                                            |
| `kubectl get service`                                                                                                                                                                                            | - получить службы из текущего контекста                                                                                                                                                                  |
| `kubectl get service -o wide`                                                                                                                                                                                    | - получить подробную информацию о службах                                                                                                                                                                |
| `kubectl get service --show-labels`                                                                                                                                                                              | - получить службы с метками на них                                                                                                                                                                       |
| `kubectl get services --all-namespaces`                                                                                                                                                                          | - получить сервисы из всех пространств имен                                                                                                                                                              |
| `kubectl describe service nginx-service`                                                                                                                                                                         | - описать сервис, чтобы узнать о нем больше                                                                                                                                                              |
| `kubectl get service nginx-service`                                                                                                                                                                              | - получить конкретный сервис                                                                                                                                                                             |
| `kubectl delete service nginx-service`                                                                                                                                                                           | - удалить сервис                                                                                                                                                                                         |
| `kubectl run mypod --image=nginx --dry-run=client -o yaml > my-pod.yml`                                                                                                                                          | - создать файл определения для pod                                                                                                                                                                       |
| `kubectl create -f my-pod.yml`                                                                                                                                                                                   | - создать объект                                                                                                                                                                                         |
| `kubectl delete -f my-pod.yml`                                                                                                                                                                                   | - удалить объект                                                                                                                                                                                         |


